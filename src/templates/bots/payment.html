{% extends "base.html" %} {% block title %}Pagamento - Telegram Bot Manager{%
endblock %} {% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">
            <i class="fas fa-qrcode me-2"></i>
            Pagamento do Bot
          </h4>
        </div>
        <div class="card-body">
          <!-- Informações do Bot -->
          <div class="row mb-4">
            <div class="col-md-6">
              <h5>
                <i class="fas fa-robot me-2"></i>
                {{ bot.bot_name or bot.bot_username }}
              </h5>
              <p class="text-muted mb-0">@{{ bot.bot_username }}</p>
            </div>
            <div class="col-md-6 text-end">
              <h3 class="text-success mb-0">
                R$ {{ "%.2f"|format(payment.amount) }}
              </h3>
              <small class="text-muted">Valor a pagar</small>
            </div>
          </div>

          <hr />

          <!-- PIX QR Code -->
          <div class="text-center mb-4">
            <h5>
              <i class="fas fa-qrcode me-2"></i>
              QR Code PIX
            </h5>
            {% if payment.pix_qr_code %}
            <div class="qr-code-container mb-3">
              <img
                src="{{ payment.pix_qr_code }}"
                alt="QR Code PIX"
                class="img-fluid border"
                style="max-width: 300px"
              />
            </div>
            {% else %}
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              QR Code não disponível
            </div>
            {% endif %}
          </div>

          <!-- PIX Copia e Cola -->
          <div class="mb-4">
            <h5>
              <i class="fas fa-copy me-2"></i>
              PIX Copia e Cola
            </h5>
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                id="pixCopyPaste"
                value="{{ payment.pix_key }}"
                readonly
              />
              <button
                class="btn btn-outline-primary"
                type="button"
                onclick="copyPixCode()"
              >
                <i class="fas fa-copy"></i>
                Copiar
              </button>
            </div>
            <small class="text-muted">
              Cole este código no seu aplicativo bancário para realizar o
              pagamento
            </small>
          </div>

          <!-- Informações Adicionais -->
          <div class="row">
            <div class="col-md-6">
              <div class="card bg-light">
                <div class="card-body">
                  <h6>
                    <i class="fas fa-info-circle me-2"></i>
                    Código do Pagamento
                  </h6>
                  <code>{{ payment.pix_code }}</code>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card bg-light">
                <div class="card-body">
                  <h6>
                    <i class="fas fa-clock me-2"></i>
                    Expira em
                  </h6>
                  {% if payment.expires_at %}
                  <span
                    id="countdown"
                    data-expires="{{ payment.expires_at.isoformat() }}"
                  >
                    Calculando...
                  </span>
                  {% else %}
                  <span class="text-muted">24 horas</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <hr />

          <!-- Botões de Ação -->
          <div class="text-center">
            <button class="btn btn-success me-2" onclick="checkPaymentStatus()">
              <i class="fas fa-sync-alt me-2"></i>
              Verificar Pagamento
            </button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
              <i class="fas fa-arrow-left me-2"></i>
              Voltar ao Dashboard
            </a>
          </div>

          <!-- Status do Pagamento -->
          <div id="paymentStatus" class="mt-3" style="display: none">
            <div class="alert alert-info">
              <i class="fas fa-spinner fa-spin me-2"></i>
              Verificando status do pagamento...
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function copyPixCode() {
    const pixInput = document.getElementById("pixCopyPaste");
    pixInput.select();
    pixInput.setSelectionRange(0, 99999); // Para dispositivos móveis

    navigator.clipboard
      .writeText(pixInput.value)
      .then(function () {
        // Feedback visual
        const button = event.target.closest("button");
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copiado!';
        button.classList.remove("btn-outline-primary");
        button.classList.add("btn-success");

        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove("btn-success");
          button.classList.add("btn-outline-primary");
        }, 2000);

        // Toast notification
        showToast(
          "Código PIX copiado para a área de transferência!",
          "success"
        );
      })
      .catch(function (err) {
        console.error("Erro ao copiar:", err);
        showToast("Erro ao copiar código PIX", "error");
      });
  }

  function checkPaymentStatus() {
    const statusDiv = document.getElementById("paymentStatus");
    statusDiv.style.display = "block";

    fetch(`/api/payments/check/{{ bot.id }}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.paid) {
          statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Pagamento confirmado! Redirecionando...
                    </div>
                `;
          setTimeout(() => {
            window.location.href = "{{ url_for('dashboard') }}";
          }, 2000);
        } else {
          statusDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-clock me-2"></i>
                        Pagamento ainda pendente. Tente novamente em alguns minutos.
                    </div>
                `;
          setTimeout(() => {
            statusDiv.style.display = "none";
          }, 3000);
        }
      })
      .catch((error) => {
        console.error("Erro:", error);
        statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Erro ao verificar pagamento. Tente novamente.
                </div>
            `;
        setTimeout(() => {
          statusDiv.style.display = "none";
        }, 3000);
      });
  }

  function showToast(message, type) {
    // Cria elemento de toast
    const toast = document.createElement("div");
    toast.className = `alert alert-${
      type === "success" ? "success" : "danger"
    } toast-notification`;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 300px;
        opacity: 0;
        transition: opacity 0.3s;
    `;
    toast.innerHTML = `
        <i class="fas fa-${
          type === "success" ? "check-circle" : "exclamation-triangle"
        } me-2"></i>
        ${message}
    `;

    document.body.appendChild(toast);

    // Animação de entrada
    setTimeout(() => {
      toast.style.opacity = "1";
    }, 100);

    // Remove após 3 segundos
    setTimeout(() => {
      toast.style.opacity = "0";
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 300);
    }, 3000);
  }

  // Countdown timer
  function updateCountdown() {
    const countdownElement = document.getElementById("countdown");
    if (!countdownElement) return;

    const expiresAt = new Date(countdownElement.dataset.expires);
    const now = new Date();
    const diff = expiresAt - now;

    if (diff <= 0) {
      countdownElement.innerHTML = '<span class="text-danger">Expirado</span>';
      return;
    }

    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

    countdownElement.innerHTML = `${hours}h ${minutes}m ${seconds}s`;
  }

  // Atualiza countdown a cada segundo
  setInterval(updateCountdown, 1000);
  updateCountdown(); // Executa imediatamente
</script>

<style>
  .qr-code-container {
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    display: inline-block;
  }

  .toast-notification {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
  }

  .card {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border: none;
  }

  .card-header {
    border-radius: 8px 8px 0 0 !important;
  }

  .input-group input {
    font-family: monospace;
    font-size: 0.9em;
  }

  code {
    background: #e9ecef;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9em;
  }
</style>
{% endblock %}
