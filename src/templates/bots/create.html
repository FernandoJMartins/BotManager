{% extends "base.html" %} {% block title %}Criar Bot - Telegram Bot Manager {%
endblock %} {% block head %}

<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
  rel="stylesheet"
/>
<style>
  .page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: 0 0 20px 20px;
  }

  .bot-edit-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    background: white;
  }

  .section-header {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    padding: 1rem 1.5rem;
    margin: -1.5rem -1.5rem 1.5rem -1.5rem;
    border-radius: 15px 15px 0 0;
  }

  .form-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border-left: 4px solid #667eea;
  }

  .form-control,
  .form-select {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
  }

  .form-control:focus,
  .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
  }

  .btn {
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .btn:hover {
    transform: translateY(-2px);
  }

  .group-id-input {
    font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
    font-size: 0.9rem;
  }

  .info-card {
    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
    border: none;
    border-radius: 10px;
    padding: 1rem;
  }

  .animate-fade-in {
    animation: fadeIn 0.6s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .value-input-group {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    border: 1px solid #dee2e6;
  }
</style>

{%endblock %} {% block content %}

<div class="page-header">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="mb-2">
          <i class="fas fa-edit me-3"></i>
          Criar Novo Bot
        </h1>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="card bot-edit-card">
    <div class="card-body p-4">
      <form method="POST" enctype="multipart/form-data">
        <!-- Informações Básicas -->

        <div class="mb-3">
          <label for="name" class="form-label fw-bold">
            <i class="fas fa-tag me-1"></i>
            Nome
          </label>
          <input
            type="text"
            class="form-control w-100"
            id="name"
            name="name"
            required
            autofocus
            maxlength="100"
            placeholder="Ex: Meu Bot de Vendas"
          />
        </div>

        <div class="mb-3">
          <label for="name" class="form-label fw-bold">
            <i class="fas fa-key me-1"></i>
            Token do Bot
          </label>
          <input
            type="text"
            class="form-control w-100"
            id="token"
            name="token"
            required
            placeholder="123456789:AAHdqTcvCH1vGWJxfSeofSAs0K5PALDsaw"
          />
          <small class="form-text text-muted">
            Token obtido do @BotFather no Telegram (⚠️ Alterar reiniciará o bot)
          </small>
        </div>

        <!-- Mensagem de Boas-vindas -->
        <div class="mb-4">
          <label for="welcome_message" class="form-label fw-bold">
            <i class="fas fa-comment me-1"></i>
            Mensagem de Boas-vindas
          </label>
          <textarea
            class="form-control"
            id="welcome_message"
            name="welcome_message"
            rows="8"
            style="
              min-height: 100px;
              font-size: 14px;
              line-height: 1.4;
              padding: 8px 12px;
            "
            placeholder="Olá! Bem-vindo ao meu bot! Escolha um valor abaixo para fazer seu PIX:"
          ></textarea>
        </div>

        <!-- Mídia de Boas-vindas -->
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="welcome_image" class="form-label fw-bold">
                <i class="fas fa-image me-1"></i>
                Imagem de Boas-vindas (opcional)
              </label>
              <input
                type="file"
                class="form-control"
                id="welcome_image"
                name="welcome_image"
                accept="image/*"
              />
              <small class="form-text text-muted">
                Imagem que será enviada junto com a mensagem de boas-vindas
              </small>
            </div>
          </div>

          <div class="col-md-6">
            <div class="mb-3">
              <label for="welcome_audio" class="form-label fw-bold">
                <i class="fas fa-volume-up me-1"></i>
                Áudio de Boas-vindas (opcional)
              </label>
              <input
                type="file"
                class="form-control"
                id="welcome_audio"
                name="welcome_audio"
                accept="audio/*"
              />
              <small class="form-text text-muted">
                Áudio que será enviado junto com a mensagem (se não houver
                imagem)
              </small>
            </div>
          </div>
        </div>

        <!-- Planos e Configurações -->
        <div class="mb-4">
          <label class="form-label fw-bold">
            <i class="fas fa-money-bill-wave me-1"></i>
            Planos e Configurações <span class="text-danger">*</span>
          </label>
          <div class="card bg-light">
            <div class="card-body">
              <div class="row mb-2">
                <div class="col-md-4"><strong>Nome</strong></div>
                <div class="col-md-3"><strong>Valor</strong></div>
                <div class="col-md-3"><strong>Duração</strong></div>
                <div class="col-md-2"><strong>Excluir</strong></div>
              </div>
              <div id="plans-container">
                <div class="value-input-group">
                  <div class="row align-items-center">
                    <div class="col-md-4">
                      <input
                        type="text"
                        class="form-control"
                        name="plan_names[]"
                        placeholder="Plano Básico"
                        maxlength="50"
                      />
                    </div>
                    <div class="col-md-3">
                      <input
                        type="number"
                        class="form-control"
                        name="pix_values[]"
                        placeholder="10.00"
                        step="1.00"
                        min="1"
                      />
                    </div>
                    <div class="col-md-3">
                      <select class="form-select" name="plan_duration[]">
                        <option value="mensal" selected>Mensal</option>
                        <option value="semanal">Semanal</option>
                        <option value="quinzenal">Quinzenal</option>
                        <option value="trimestral">Trimestral</option>
                        <option value="semestral">Semestral</option>
                        <option value="anual">Anual</option>
                        <option value="vitalicio">Vitalício</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <!-- Removido inicialmente -->
                    </div>
                  </div>
                </div>
                <div class="value-input-group">
                  <div class="row align-items-center">
                    <div class="col-md-4">
                      <input
                        type="text"
                        class="form-control"
                        name="plan_names[]"
                        placeholder="Plano Premium"
                        maxlength="50"
                      />
                    </div>
                    <div class="col-md-3">
                      <input
                        type="number"
                        class="form-control"
                        name="pix_values[]"
                        placeholder="20.00"
                        step="1.00"
                        min="1"
                      />
                    </div>
                    <div class="col-md-3">
                      <select class="form-select" name="plan_duration[]">
                        <option value="mensal" selected>Mensal</option>
                        <option value="semanal">Semanal</option>
                        <option value="quinzenal">Quinzenal</option>
                        <option value="trimestral">Trimestral</option>
                        <option value="semestral">Semestral</option>
                        <option value="anual">Anual</option>
                        <option value="vitalicio">Vitalício</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <button
                        type="button"
                        class="btn btn-outline-danger btn-sm w-100"
                        onclick="removePlan(this)"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="value-input-group">
                  <div class="row align-items-center">
                    <div class="col-md-4">
                      <input
                        type="text"
                        class="form-control"
                        name="plan_names[]"
                        placeholder="Plano VIP"
                        maxlength="50"
                      />
                    </div>
                    <div class="col-md-3">
                      <input
                        type="number"
                        class="form-control"
                        name="pix_values[]"
                        placeholder="50.00"
                        step="1.00"
                        min="1"
                      />
                    </div>
                    <div class="col-md-3">
                      <select class="form-select" name="plan_duration[]">
                        <option value="mensal" selected>Mensal</option>
                        <option value="semanal">Semanal</option>
                        <option value="quinzenal">Quinzenal</option>
                        <option value="trimestral">Trimestral</option>
                        <option value="semestral">Semestral</option>
                        <option value="anual">Anual</option>
                        <option value="vitalicio">Vitalício</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <button
                        type="button"
                        class="btn btn-outline-danger btn-sm w-100"
                        onclick="removePlan(this)"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-3">
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary"
                  onclick="addPlan()"
                >
                  <i class="fas fa-plus me-1"></i>
                  Adicionar Plano
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Configurações de Grupos -->
        <div class="mb-4">
          <label class="form-label fw-bold">
            <i class="fas fa-users me-1"></i>
            Configurações de Grupos <span class="text-danger">*</span>
          </label>
          <div class="card bg-light">
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="id_vip" class="form-label fw-bold">
                      <i class="fas fa-crown me-1"></i>ID do Grupo VIP
                    </label>
                    <input
                      type="text"
                      class="form-control group-id-input"
                      id="id_vip"
                      name="id_vip"
                      placeholder="-1001234567890"
                      style="
                        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                        font-size: 0.9rem;
                      "
                    />
                    <small class="form-text text-muted">
                      Grupo onde os clientes serão adicionados após pagamento
                      aprovado
                    </small>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="id_logs" class="form-label fw-bold">
                      <i class="fas fa-clipboard-list me-1"></i>ID do Grupo de
                      Notificações
                    </label>
                    <input
                      type="text"
                      class="form-control group-id-input"
                      id="id_logs"
                      name="id_logs"
                      placeholder="-1001234567890"
                      style="
                        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                        font-size: 0.9rem;
                      "
                    />
                    <small class="form-text text-muted">
                      Grupo onde serão enviadas notificações de pagamentos
                    </small>
                  </div>
                </div>
              </div>

              <div class="alert alert-warning">
                <h6>
                  <i class="fas fa-lightbulb me-2"></i>Como obter o ID do grupo:
                </h6>
                <ol class="mb-0 small">
                  <li>Pesquise @chat_id_echo_bot no seu telegram</li>
                  <li>
                    Digite <code>/start</code> e selecione no grupo ou canal
                  </li>
                  <li>O bot retornará o ID do grupo (ex: -1001234567890)</li>
                </ol>
              </div>

              <div class="alert alert-info">
                <strong>💡 Importante:</strong> A imagem e áudio de boas-vindas
                só serão enviados se ambos os grupos (VIP e Notificações)
                estiverem configurados.
              </div>
            </div>
          </div>
        </div>

        <!-- Informações Importantes -->
        <div class="alert alert-info">
          <h6><i class="fas fa-info-circle me-2"></i>Como funciona:</h6>
          <ul class="mb-0">
            <li>Seu bot ficará ativo 24/7 automaticamente</li>
            <li>
              Qualquer pessoa que enviar /start receberá sua mensagem e botões
              de valores
            </li>
            <li>
              Quando clicarem em um valor, será gerado um PIX real via sua conta
              PushinPay
            </li>
            <li>
              Você receberá os pagamentos diretamente (menos 5% de comissão da
              plataforma)
            </li>
            <li>
              O cliente será notificado automaticamente quando o pagamento for
              confirmado
            </li>
          </ul>
        </div>

        <!-- Botões de Ação -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
          <a
            href="{{ url_for('dashboard') }}"
            class="btn btn-secondary me-md-2"
          >
            <i class="fas fa-arrow-left me-2"></i>
            Cancelar
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-robot me-2"></i>
            Criar e Ativar Bot
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Conta o número atual de planos carregados
  let planCount = document.querySelectorAll(".value-input-group").length;

  function addPlan() {
    if (planCount >= 10) {
      alert("Máximo de 10 planos permitidos");
      return;
    }

    const container = document.getElementById("plans-container");
    const newPlan = document.createElement("div");
    newPlan.className = "value-input-group";

    newPlan.innerHTML = `
    <div class="row align-items-center">
      <div class="col-md-4">
        <input
          type="text"
          class="form-control"
          name="plan_names[]"
          placeholder="Plano Premium"
          maxlength="50"
        />
      </div>
      <div class="col-md-3">
        <input
          type="number"
          class="form-control"
          name="pix_values[]"
          placeholder="19.90"
          step="1.00"
          min="1"
        />
      </div>
      <div class="col-md-3">
        <select class="form-select" name="plan_duration[]">
          <option value="">Selecione...</option>
          <option value="semanal">Semanal</option>
          <option value="quinzenal">Quinzenal</option>
          <option value="mensal">Mensal</option>
          <option value="trimestral">Trimestral</option>
          <option value="semestral">Semestral</option>
          <option value="anual">Anual</option>
          <option value="vitalicio">Vitalício</option>
        </select>
      </div>
      <div class="col-md-2">
        <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removePlan(this)">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  `;

    container.appendChild(newPlan);
    planCount++;
    updateRemoveButtons();
  }

  function removePlan(button) {
    const container = document.getElementById("plans-container");
    const plans = container.querySelectorAll(".value-input-group");

    // Não permite remover se há apenas um plano
    if (plans.length <= 1) {
      alert("Deve haver pelo menos um plano configurado!");
      return;
    }

    const planGroup = button.closest(".value-input-group");
    planGroup.remove();
    planCount--;
    updateRemoveButtons();
  }

  function updateRemoveButtons() {
    const container = document.getElementById("plans-container");
    const plans = container.querySelectorAll(".value-input-group");
    const removeButtons = container.querySelectorAll(".btn-outline-danger");

    // Mostra/esconde botões de remover baseado no número de planos
    removeButtons.forEach((button) => {
      button.style.display = plans.length > 1 ? "block" : "none";
    });
  }

  // Inicializa os botões de remover quando a página carrega
  document.addEventListener("DOMContentLoaded", function () {
    updateRemoveButtons();
  });

  // Validação do formulário
  document.querySelector("form").addEventListener("submit", function (e) {
    const pixInputs = document.querySelectorAll('input[name="pix_values[]"]');
    const planInputs = document.querySelectorAll('input[name="plan_names[]"]');
    const durationInputs = document.querySelectorAll(
      'select[name="plan_duration[]"]'
    );

    const hasValue = Array.from(pixInputs).some(
      (input) => input.value && parseFloat(input.value) > 0
    );

    const hasName = Array.from(planInputs).some(
      (input) => input.value && input.value.trim()
    );

    const hasDuration = Array.from(durationInputs).some(
      (input) => input.value && input.value.trim()
    );

    if (!hasValue) {
      e.preventDefault();
      alert("Configure pelo menos um valor PIX para o seu bot!");
      return;
    }

    if (!hasName) {
      e.preventDefault();
      alert("Configure pelo menos um nome de plano para o seu bot!");
      return;
    }

    if (!hasDuration) {
      e.preventDefault();
      alert("Configure pelo menos uma duração de plano para o seu bot!");
      return;
    }

    // Verificar se o token está no formato correto
    const token = document.getElementById("token").value;
    const tokenPattern = /^\d+:[A-Za-z0-9_-]+$/;

    if (!tokenPattern.test(token)) {
      e.preventDefault();
      alert(
        "Token do bot inválido! Verifique se copiou corretamente do @BotFather."
      );
      return;
    }
  });

  // Auto-formatação dos IDs de grupo
  function formatGroupId(input) {
    let value = input.value.replace(/[^\d-]/g, "");
    if (value && !value.startsWith("-")) {
      value = "-" + value;
    }
    input.value = value;
  }

  document.getElementById("id_vip").addEventListener("input", function () {
    formatGroupId(this);
  });

  document.getElementById("id_logs").addEventListener("input", function () {
    formatGroupId(this);
  });
</script>

<style>
  .pix-value-row {
    margin-bottom: 0.5rem;
  }

  .card {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border: none;
  }

  .card-header {
    border-radius: 8px 8px 0 0 !important;
  }

  .form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
  }

  .btn {
    border-radius: 6px;
  }
</style>
{% endblock %}
