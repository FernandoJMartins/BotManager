{% extends "base_dark.html" %} {% block title %}Order Bump - {{ bot.bot_username
}}{% endblock %} 

{% block extra_css%}
<link rel="stylesheet" href="{{ url_for('static', filename='css/create-bot.css') }}" >
<script src="{{url_for('static', filename='js/form-utils.js')}}"></script>
{% endblock %}

{% block content %}
<header
  class="dashboard-header"
>
  <div class="header-left" >
    <h1>
      <i class="fas fa-gift" style="color: var(--purple)"></i>
      Configurar Order Bump
    </h1>
    <p style="color: var(--text-secondary)">
      Bot: {{ bot.bot_username }}
    </p>
  </div>
</header>

  <!-- Error Display -->
  <div id="errorDisplay" class="error-display" style="display: none;">
    <div class="error-content">
      <i class="fas fa-exclamation-triangle"></i>
      <div class="error-text">
        <strong id="errorTitle">Erro ao salvar</strong>
        <span id="errorMessage"></span>
      </div>
      <button type="button" onclick="hideError()">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <!-- Success Display -->
  <div id="successDisplay" class="success-display" style="display: none;">
    <div class="success-content">
      <i class="fas fa-check-circle"></i>
      <div class="success-text">
        <strong id="successTitle">Salvo com sucesso!</strong>
        <span id="successMessage">Order Bump atualizado.</span>
      </div>
      <button type="button" onclick="hideSuccess()">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <div class="form-container">
    <form method="POST" enctype="multipart/form-data" class="order-bump-form">
      <!-- Informa√ß√µes B√°sicas -->
      <div class="chart-card" style="margin-bottom: 24px">

        <div class="form-group">
          <label class="form-label">Nome da Oferta <span class="required">*</span></label>
          <input
            type="text"
            name="name"
            class="form-control form-input"
            value="{{ order_bump.name if order_bump else '' }}"
            required
            placeholder="Ex: B√¥nus Exclusivo VIP"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Pre√ßo (R$) <span class="required">*</span></label>
          <input
            type="number"
            name="price"
            class="form-control form-input"
            step="0.01"
            min="0"
            value="{{ order_bump.order_bump_config.price if order_bump and order_bump.order_bump_config else '' }}"
            required
            placeholder="Ex: 19.90"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Mensagem da Oferta <span class="required">*</span></label>
          <textarea
            name="message"
            class="form-control form-textarea"
            rows="6"
            required
            placeholder="üéÅ OFERTA ESPECIAL!&#10;&#10;Ganhe acesso ao conte√∫do b√¥nus por apenas R$ 19,90!"
          >
{{ order_bump.message if order_bump else '' }}</textarea
          >
          <small class="form-hint"
            >Mensagem que ser√° exibida ao cliente quando a oferta
            aparecer</small
          >
        </div>

        <div class="media-grid">
          <!-- M√≠dia da Oferta (Imagem/V√≠deo) -->
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-image me-2"></i>
              Imagem/V√≠deo da Oferta
            </label>

            <div class="file-input-wrapper">
              <input
                type="file"
                class="form-file"
                id="offer_media_image"
                name="offer_media_image"
                accept="image/*,video/mp4,video/avi,video/mov,video/mkv,video/webm"
                onchange="handleMediaUpload(this, 'offerMediaPreview')"
              />
              <label for="offer_media_image" class="file-label">
                <i class="fas fa-cloud-upload-alt me-2"></i>
                <span class="upload-text">Escolher M√≠dia</span>
                <span class="upload-limit">(M√°x: 50MB)</span>
              </label>
            </div>

            <div
              id="offerMediaPreview"
              class="media-preview"
              style="display: none"
            ></div>

            <small class="form-hint">
              Imagem ou v√≠deo que ser√° exibido junto com a oferta
            </small>
          </div>

          <!-- √Åudio da Oferta -->
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-volume-up me-2"></i>
              √Åudio da Oferta
            </label>

            <div class="file-input-wrapper">
              <input
                type="file"
                class="form-file"
                id="offer_media_audio"
                name="offer_media_audio"
                accept="audio/ogg"
                onchange="handleAudioUpload(this, 'offerAudioPreview')"
              />
              <label for="offer_media_audio" class="file-label">
                <i class="fas fa-cloud-upload-alt me-2"></i>
                <span class="upload-text">Escolher √Åudio</span>
                <span class="upload-limit">(M√°x: 25MB)</span>
              </label>
            </div>

            <div
              id="offerAudioPreview"
              class="media-preview"
              style="display: none"
            ></div>

            <small class="form-hint"
              >√Åudio que ser√° enviado junto com a oferta (formato OGG)</small
            >
          </div>
        </div>

        <div class="form-group">
          
          <label class="form-label"><i class="fas fa-gift me-2"></i>Mensagem do Entreg√°vel<span class="required">*</span></label>
          <textarea
            name="deliverable_message"
            required
            class="form-control form-textarea"
            rows="5"
            placeholder="üéâ Parab√©ns! Aqui est√° seu b√¥nus exclusivo:&#10;&#10;üìå Link de acesso: https://t.me/+abcdEFG12345&#10;üìå Aproveite!"
          >
{{ order_bump.deliverable_message if order_bump else '' }}</textarea
          >
          <small class="form-hint">
            Mensagem que ser√° enviada ao cliente ap√≥s confirmar o pagamento do
            Order Bump
          </small>
        </div>

        <div class="media-grid">
          <div class="form-group">
            <label class="form-label">Texto do Bot√£o de Aceitar <span class="required">*</span></label>
            <input
              type="text"
              name="accept_button_text"
              class="form-control form-input"
              value="{{ order_bump.accept_button_text if order_bump else 'üü¢ACEITOüü¢' }}"
              required
              placeholder="üü¢ACEITOüü¢"
            />
          </div>

          <div class="form-group">
            <label class="form-label">Texto do Bot√£o de Recusar <span class="required">*</span></label>
            <input
              type="text"
              name="decline_button_text"
              class="form-control form-input"
              value="{{ order_bump.decline_button_text if order_bump else '‚ùåN√£o Quero‚ùå' }}"
              required
              placeholder="‚ùåN√£o Quero‚ùå"
            />
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" name="is_active" id="is_active" {{ 'checked' if order_bump
            and order_bump.is_active else '' }} />
            <span>Ativar Order Bump</span>
          </label>
          <small class="form-hint">
            Quando ativo, a oferta ser√° exibida ap√≥s sele√ß√£o de plano
          </small>
        </div>
      </div>

      <!-- A√ß√µes -->
      <div class="form-actions">
        <a href="{{ url_for('bots.list_bots') }}" class="btn-secondary">
          <i class="fas fa-arrow-left"></i> Voltar
        </a>
        <button type="submit" class="btn-primary" id="submitBtn">
          <i class="fas fa-save"></i> <span id="submitText">Salvar Order Bump</span>
          <div class="btn-spinner" style="display: none;"></div>
        </button>
      </div>
    </form>
  </div>
</div>


<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('form.order-bump-form');
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (document.getElementById('submitBtn')?.disabled) return;

      const check = validateOrderBumpSection({ form });
      if (!check.ok) { showError(check.title, check.message); return; }

      try {
        showLoading({ submitLoadingText: 'Salvando...' });
        const fd = new FormData(form);
        const resp = await fetch(form.action || window.location.href, { method: 'POST', body: fd });
        if (resp.ok) {
          hideLoading();
          showSuccess('Order Bump salvo!', 'As altera√ß√µes foram aplicadas.');
          setTimeout(() => { window.location.href = "{{ url_for('bots.list_bots') }}"; }, 1200);
        } else {
          const text = await resp.text();
          throw new Error(text || `Erro HTTP ${resp.status}`);
        }
      } catch (err) {
        hideLoading();
        showError('Erro ao salvar', String(err?.message || err));
      }
    });
  });
</script>


{% endblock %} 