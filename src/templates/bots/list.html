{% extends "base_dark.html" %} {% block title %}Meus Bots - BotManager{%
endblock %} {% block content %}
<div class="bot-list-page">
  <!-- Dashboard Header -->
  <header class="dashboard-header">
    <div class="header-left">
      <h1>Meus Bots</h1>
      <p>Gerencie e monitore seus bots do Telegram</p>
    </div>
    <div class="header-right">
      {% if can_add_more %}
      <a href="{{ url_for('bots.create_bot') }}" class="btn-primary">
        <i class="fas fa-plus"></i>Novo Bot
      </a>
      {% else %}
      <div
        class="alert"
        style="
          background: rgba(239, 68, 68, 0.1);
          color: #ef4444;
          border: 1px solid rgba(239, 68, 68, 0.3);
          padding: 8px 16px;
          border-radius: 8px;
          font-size: 14px;
        "
      >
        <i class="fas fa-exclamation-triangle"></i>
        Limite atingido
      </div>
      {% endif %}
    </div>
  </header>

  {% if bots %}
  <!-- Grid de Bots -->
  <div class="stats-grid">
    {% for bot in bots %}
    <div
      class="stat-card bot-card {{ 'running' if bot.is_running else ('inactive' if not bot.is_active else '') }}"
      data-bot-id="{{ bot.id }}"
    >
      <div class="stat-header">
        <div class="stat-title">
          <i class="fas fa-robot"></i>
          {{ bot.username or bot.name or 'bot_' + bot.id|string }}
        </div>

        {% if bot.is_active %} {% if bot.is_running %}
        <span class="status-badge running">
          <i class="fas fa-play"></i>RODANDO
        </span>
        {% else %}
        <span class="status-badge active">
          <i class="fas fa-check"></i>ATIVO
        </span>
        {% endif %} {% else %}
        <span class="status-badge pending">
          <i class="fas fa-clock"></i>PENDENTE
        </span>
        {% endif %}
      </div>

      <div class="bot-details">
        <div class="bot-info-item">
          <i class="fas fa-calendar"></i>
          <span
            >{{ bot.created_at[:10] if bot.created_at else '2025-10-01' }}</span
          >
        </div>
        <div class="bot-info-item">
          <i
            class="fas fa-circle {{ 'online' if bot.is_running else 'offline' }}"
          ></i>
          <span>{{ 'Online' if bot.is_running else 'Offline' }}</span>
        </div>
      </div>

      <!-- A√ß√µes -->
      <div class="bot-actions">
        {% if bot.is_active %}
        <div class="action-buttons">
          <a
            href="{{ url_for('bots.edit_bot', slug=bot.id) }}"
            class="btn-secondary btn-small"
            title="Editar Bot"
          >
            <i class="fas fa-edit"></i>
          </a>
          <button
            class="btn-secondary btn-small btn-danger"
            title="Excluir Bot"
            data-action="delete"
            data-bot-id="{{ bot.id }}"
            data-bot-name="{{ bot.name }}"
          >
            <i class="fas fa-trash"></i>
          </button>
          {% if not bot.is_running %}
          <button
            class="btn-secondary btn-small btn-success"
            title="Iniciar Bot"
            data-action="start"
            data-bot-id="{{ bot.id }}"
          >
            <i class="fas fa-play"></i>
          </button>
          {% else %}
          <button
            class="btn-secondary btn-small btn-warning"
            title="Parar Bot"
            data-action="stop"
            data-bot-id="{{ bot.id }}"
          >
            <i class="fas fa-stop"></i>
          </button>
          {% endif %}
        </div>
        {% else %}
        <button
          class="btn-secondary inactive-btn"
          onclick="alert('Bot inativo. Configure o bot primeiro.')"
        >
          <i class="fas fa-exclamation-triangle"></i>Bot Inativo
        </button>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>

  {% else %}
  <!-- Estado Vazio -->
  <div class="chart-card">
    <div class="empty-state">
      <i class="fas fa-robot"></i>
      <h3>Nenhum bot cadastrado</h3>
      <p>
        Comece criando seu primeiro bot do Telegram e transforme suas ideias em
        realidade!
      </p>
      {% if can_add_more %}
      <a href="{{ url_for('bots.create_bot') }}" class="btn-primary">
        <i class="fas fa-plus"></i>Criar Primeiro Bot
      </a>
      {% else %}
      <div
        class="alert"
        style="
          background: rgba(239, 68, 68, 0.1);
          color: #ef4444;
          border: 1px solid rgba(239, 68, 68, 0.3);
          padding: 12px 20px;
          border-radius: 8px;
        "
      >
        <i class="fas fa-exclamation-triangle"></i>
        Limite m√°ximo de bots atingido
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>
<!-- Fecha bot-list-page -->
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Event delegation para a√ß√µes dos bots
    document.addEventListener("click", handleBotActions);
  });

  function handleBotActions(event) {
    const target = event.target.closest("[data-action]");
    if (!target) return;

    const action = target.dataset.action;
    const botId = target.dataset.botId;
    const botName = target.dataset.botName;

    if (target.disabled) return;

    switch (action) {
      case "delete":
        deleteBot(botId, botName, target);
        break;
      case "start":
        startBot(botId, target);
        break;
      case "stop":
        stopBot(botId, target);
        break;
    }
  }

  function deleteBot(botId, botName, buttonElement) {
    // Modal de confirma√ß√£o personalizado
    const confirmed = confirm(
      `ü§ñ Tem certeza que deseja excluir o bot "${botName}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`
    );
    if (!confirmed) return;

    setButtonLoading(buttonElement, "Excluindo...");

    fetch(`/bots/${botId}`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const card = buttonElement.closest(".bot-card");
          card.style.transition = "all 0.5s ease";
          card.style.opacity = "0";
          card.style.transform = "scale(0.8) translateY(-20px)";

          showNotification("Bot exclu√≠do com sucesso!", "success");

          setTimeout(() => {
            location.reload();
          }, 1000);
        } else {
          showNotification("Erro ao excluir bot: " + data.message, "error");
          resetButton(buttonElement, '<i class="fas fa-trash"></i>');
        }
      })
      .catch((error) => {
        console.error("Erro:", error);
        showNotification("Erro ao excluir bot", "error");
        resetButton(buttonElement, '<i class="fas fa-trash"></i>');
      });
  }

  function startBot(botId, buttonElement) {
    setButtonLoading(buttonElement, "Iniciando...");

    fetch(`/bots/${botId}/start`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showNotification("Bot iniciado com sucesso! üöÄ", "success");
          setTimeout(() => {
            location.reload();
          }, 1500);
        } else {
          showNotification("Erro ao iniciar bot: " + data.message, "error");
          resetButton(buttonElement, '<i class="fas fa-play"></i>');
        }
      })
      .catch((error) => {
        console.error("Erro:", error);
        showNotification("Erro ao iniciar bot", "error");
        resetButton(buttonElement, '<i class="fas fa-play"></i>');
      });
  }

  function stopBot(botId, buttonElement) {
    setButtonLoading(buttonElement, "Parando...");

    fetch(`/bots/${botId}/stop`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showNotification("Bot parado com sucesso!", "success");
          setTimeout(() => {
            location.reload();
          }, 1500);
        } else {
          showNotification("Erro ao parar bot: " + data.message, "error");
          resetButton(buttonElement, '<i class="fas fa-stop"></i>');
        }
      })
      .catch((error) => {
        console.error("Erro:", error);
        showNotification("Erro ao parar bot", "error");
        resetButton(buttonElement, '<i class="fas fa-stop"></i>');
      });
  }

  function setButtonLoading(button, text) {
    button.disabled = true;
    button.innerHTML = `<i class="fas fa-spinner fa-spin" style="margin-right: 6px;"></i>${text}`;
  }

  function resetButton(button, originalHtml) {
    button.disabled = false;
    button.innerHTML = originalHtml;
  }

  function showNotification(message, type = "info") {
    // Remover notifica√ß√µes existentes
    const existingAlerts = document.querySelectorAll(".notification");
    existingAlerts.forEach((alert) => alert.remove());

    const alertStyles = {
      success: {
        bg: "var(--success-bg)",
        color: "var(--success)",
        border: "var(--success)",
      },
      error: {
        bg: "var(--danger-bg)",
        color: "var(--danger)",
        border: "var(--danger)",
      },
      warning: {
        bg: "rgba(245, 158, 11, 0.1)",
        color: "#f59e0b",
        border: "#f59e0b",
      },
      info: {
        bg: "rgba(139, 92, 246, 0.1)",
        color: "var(--purple)",
        border: "var(--purple)",
      },
    };

    const alertIcon =
      {
        success: "fas fa-check-circle",
        error: "fas fa-times-circle",
        warning: "fas fa-exclamation-triangle",
        info: "fas fa-info-circle",
      }[type] || "fas fa-info-circle";

    const style = alertStyles[type] || alertStyles.info;

    const alertHtml = `
      <div class="notification" style="
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        background: ${style.bg};
        color: ${style.color};
        border: 1px solid ${style.border};
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        gap: 8px;
        animation: slideInFromRight 0.3s ease-out;
        max-width: 400px;
      ">
        <i class="${alertIcon}"></i>
        ${message}
        <button onclick="this.parentElement.remove()" style="
          background: none;
          border: none;
          color: ${style.color};
          cursor: pointer;
          margin-left: 8px;
          font-size: 16px;
          padding: 0;
          opacity: 0.7;
        ">√ó</button>
      </div>
    `;

    document.body.insertAdjacentHTML("beforeend", alertHtml);

    // Auto-dismiss ap√≥s 5 segundos
    setTimeout(() => {
      const alert = document.querySelector(".notification");
      if (alert) {
        alert.style.animation = "slideOutToRight 0.3s ease-in";
        setTimeout(() => alert.remove(), 300);
      }
    }, 5000);
  }

  // Auto-refresh para bots pendentes
  const hasPendingBots = document.querySelector(".status-badge.pending");
  if (hasPendingBots) {
    setTimeout(() => {
      location.reload();
    }, 60000);
  }
</script>
{% endblock %}
