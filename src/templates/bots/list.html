{% extends "base.html" %} {% block title %}Meus Bots - Telegram Bot Manager{%
endblock %} {% block head %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/dashboard-improved.css') }}"
/>
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
  rel="stylesheet"
/>
<style>
  .bots-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: 0 0 20px 20px;
  }

  .bot-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    overflow: hidden;
    background: white;
  }

  .bot-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
  }

  .bot-card .card-header {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border: none;
    padding: 1.25rem;
  }

  .bot-card.inactive .card-header {
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
  }

  .bot-card.running .card-header {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    color: #333;
  }

  .status-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.875rem;
  }

  .status-badge.active {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
  }

  .status-badge.pending {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    color: white;
  }

  .status-badge.running {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    color: white;
  }

  .bot-info-item {
    display: flex;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f8f9fa;
  }

  .bot-info-item:last-child {
    border-bottom: none;
  }

  .bot-info-item i {
    width: 20px;
    text-align: center;
  }

  .action-buttons .btn {
    border-radius: 10px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .action-buttons .btn:hover {
    transform: translateY(-2px);
  }

  .empty-state {
    padding: 4rem 2rem;
    text-align: center;
  }

  .empty-state i {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .stats-overview {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .animate-fade-in-up {
    animation: fadeInUp 0.6s ease-out;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    min-width: 300px;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  }
</style>
{% endblock %} {% block content %}
<!-- Header da p√°gina -->
<div class="bots-header">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="mb-2">
          <i class="fas fa-robot me-3"></i>
          Meus Bots
        </h1>
        <p class="mb-0 opacity-75">
          Gerencie todos os seus bots do Telegram {% if bots %}
          <span class="badge bg-light text-dark ms-2 px-3 py-2">
            {{ bots|length }} bot{{ 's' if bots|length != 1 else '' }}
          </span>
          {% endif %}
        </p>
      </div>
      <div class="d-flex gap-2">
        {% if can_add_more %}
        <a href="{{ url_for('bots.create_bot') }}" class="btn btn-light btn-lg">
          <i class="fas fa-plus me-2"></i>Novo Bot
        </a>
        {% else %}
        <span class="badge bg-warning fs-6 px-3 py-2">
          <i class="fas fa-exclamation-triangle me-1"></i>
          Limite atingido
        </span>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="container">
  {% if bots %}
  <!-- Estat√≠sticas Overview -->
  <div class="stats-overview animate-fade-in-up"></div>

  <!-- Grid de Bots -->
  <div class="row">
    {% for bot in bots %}
    <div class="col-md-6 col-lg-4 mb-4">
      <div
        class="card bot-card animate-fade-in-up {{ 'running' if bot.is_running else ('inactive' if not bot.is_active else '') }}"
        data-bot-id="{{ bot.id }}"
      >
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <i class="fas fa-robot fa-lg me-2"></i>
              <h6 class="mb-0 fw-bold">{{ bot.name }}</h6>
            </div>
            <span
              class="status-badge {{ 'active' if bot.is_active else 'pending' }}"
            >
              {% if bot.is_active %} {% if bot.is_running %}
              <i class="fas fa-play me-1"></i>Rodando {% else %}
              <i class="fas fa-check me-1"></i>Ativo {% endif %} {% else %}
              <i class="fas fa-clock me-1"></i>Pendente {% endif %}
            </span>
          </div>
        </div>

        <div class="card-body p-3">
          <!-- Informa√ß√µes do Bot -->
          <div class="bot-info mb-3">
            <div class="bot-info-item">
              <i class="fas fa-at text-primary me-2"></i>
              <span class="text-muted">@{{ bot.username }}</span>
            </div>
            <div class="bot-info-item">
              <i class="fas fa-calendar text-info me-2"></i>
              <span class="text-muted">
                {{ bot.created_at[:10] if bot.created_at else 'N/A' }}
              </span>
            </div>
            <div class="bot-info-item">
              <i
                class="fas fa-circle text-{{ 'success' if bot.is_running else 'secondary' }} me-2"
              ></i>
              <span class="text-{{ 'success' if bot.is_running else 'muted' }}">
                {{ 'Online' if bot.is_running else 'Offline' }}
              </span>
            </div>
          </div>

          <!-- A√ß√µes -->
          <div class="action-buttons">
            {% if bot.is_active %}
            <div class="d-grid gap-2">
              <div class="btn-group" role="group">
                <a
                  href="{{ url_for('bots.edit_bot', slug=bot.id) }}"
                  class="btn btn-outline-primary btn-sm"
                  data-bs-toggle="tooltip"
                  title="Editar Bot"
                >
                  <i class="fas fa-edit"></i>
                </a>
                <button
                  class="btn btn-outline-danger btn-sm"
                  data-bs-toggle="tooltip"
                  title="Excluir Bot"
                  data-action="delete"
                  data-bot-id="{{ bot.id }}"
                  data-bot-name="{{ bot.name }}"
                >
                  <i class="fas fa-trash"></i>
                </button>
                {% if not bot.is_running %}
                <button
                  class="btn btn-outline-success btn-sm"
                  data-bs-toggle="tooltip"
                  title="Iniciar Bot"
                  data-action="start"
                  data-bot-id="{{ bot.id }}"
                >
                  <i class="fas fa-play"></i>
                </button>
                {% else %}
                <button
                  class="btn btn-outline-warning btn-sm"
                  data-bs-toggle="tooltip"
                  title="Parar Bot"
                  data-action="stop"
                  data-bot-id="{{ bot.id }}"
                >
                  <i class="fas fa-stop"></i>
                </button>
                {% endif %}
              </div>
            </div>
            {% else %}
            <div class="d-grid">
              <a
                href="{{ url_for('bots.payment_status', bot_id=bot.id) }}"
                class="btn btn-warning"
              >
                <i class="fas fa-credit-card me-2"></i>Pagar via PIX
              </a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {% else %}
  <!-- Estado Vazio -->
  <div class="card">
    <div class="card-body">
      <div class="empty-state animate-fade-in-up">
        <i class="fas fa-robot fa-5x mb-4"></i>
        <h3 class="text-muted mb-3">Nenhum bot cadastrado</h3>
        <p class="text-muted mb-4 lead">
          Comece criando seu primeiro bot do Telegram e transforme suas ideias
          em realidade!
        </p>
        {% if can_add_more %}
        <a
          href="{{ url_for('bots.create_bot') }}"
          class="btn btn-primary btn-lg"
        >
          <i class="fas fa-plus me-2"></i>Criar Primeiro Bot
        </a>
        {% else %}
        <div class="alert alert-warning d-inline-block">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Limite m√°ximo de bots atingido
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Inicializar tooltips
    const tooltipTriggerList = [].slice.call(
      document.querySelectorAll('[data-bs-toggle="tooltip"]')
    );
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Event delegation para a√ß√µes dos bots
    document.addEventListener("click", handleBotActions);
  });

  function handleBotActions(event) {
    const target = event.target.closest("[data-action]");
    if (!target) return;

    const action = target.dataset.action;
    const botId = target.dataset.botId;
    const botName = target.dataset.botName;

    if (target.disabled) return;

    switch (action) {
      case "delete":
        deleteBot(botId, botName, target);
        break;
      case "start":
        startBot(botId, target);
        break;
      case "stop":
        stopBot(botId, target);
        break;
    }
  }

  function deleteBot(botId, botName, buttonElement) {
    // Modal de confirma√ß√£o personalizado
    const confirmed = confirm(
      `ü§ñ Tem certeza que deseja excluir o bot "${botName}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`
    );
    if (!confirmed) return;

    setButtonLoading(buttonElement, "Excluindo...");

    fetch(`/bots/${botId}`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const card = buttonElement.closest(".bot-card");
          card.style.transition = "all 0.5s ease";
          card.style.opacity = "0";
          card.style.transform = "scale(0.8) translateY(-20px)";

          showNotification("Bot exclu√≠do com sucesso!", "success");

          setTimeout(() => {
            location.reload();
          }, 1000);
        } else {
          showNotification("Erro ao excluir bot: " + data.message, "error");
          resetButton(buttonElement, '<i class="fas fa-trash"></i>');
        }
      })
      .catch((error) => {
        console.error("Erro:", error);
        showNotification("Erro ao excluir bot", "error");
        resetButton(buttonElement, '<i class="fas fa-trash"></i>');
      });
  }

  function startBot(botId, buttonElement) {
    setButtonLoading(buttonElement, "Iniciando...");

    fetch(`/bots/${botId}/start`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showNotification("Bot iniciado com sucesso! üöÄ", "success");
          setTimeout(() => {
            location.reload();
          }, 1500);
        } else {
          showNotification("Erro ao iniciar bot: " + data.message, "error");
          resetButton(buttonElement, '<i class="fas fa-play"></i>');
        }
      })
      .catch((error) => {
        console.error("Erro:", error);
        showNotification("Erro ao iniciar bot", "error");
        resetButton(buttonElement, '<i class="fas fa-play"></i>');
      });
  }

  function stopBot(botId, buttonElement) {
    setButtonLoading(buttonElement, "Parando...");

    fetch(`/bots/${botId}/stop`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showNotification("Bot parado com sucesso!", "success");
          setTimeout(() => {
            location.reload();
          }, 1500);
        } else {
          showNotification("Erro ao parar bot: " + data.message, "error");
          resetButton(buttonElement, '<i class="fas fa-stop"></i>');
        }
      })
      .catch((error) => {
        console.error("Erro:", error);
        showNotification("Erro ao parar bot", "error");
        resetButton(buttonElement, '<i class="fas fa-stop"></i>');
      });
  }

  function setButtonLoading(button, text) {
    button.disabled = true;
    button.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>${text}`;
  }

  function resetButton(button, originalHtml) {
    button.disabled = false;
    button.innerHTML = originalHtml;
  }

  function showNotification(message, type = "info") {
    // Remover notifica√ß√µes existentes
    const existingAlerts = document.querySelectorAll(".notification");
    existingAlerts.forEach((alert) => alert.remove());

    const alertClass =
      {
        success: "alert-success",
        error: "alert-danger",
        warning: "alert-warning",
        info: "alert-info",
      }[type] || "alert-info";

    const alertIcon =
      {
        success: "fas fa-check-circle",
        error: "fas fa-times-circle",
        warning: "fas fa-exclamation-triangle",
        info: "fas fa-info-circle",
      }[type] || "fas fa-info-circle";

    const alertHtml = `
    <div class="alert ${alertClass} alert-dismissible fade show notification animate-fade-in-up" role="alert">
      <i class="${alertIcon} me-2"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  `;

    document.body.insertAdjacentHTML("beforeend", alertHtml);

    // Auto-dismiss ap√≥s 5 segundos
    setTimeout(() => {
      const alert = document.querySelector(".notification");
      if (alert) {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
      }
    }, 5000);
  }

  // Auto-refresh para bots pendentes
  const hasPendingBots = document.querySelector(".status-badge.pending");
  if (hasPendingBots) {
    setTimeout(() => {
      location.reload();
    }, 60000);
  }
</script>
{% endblock %}
