{% extends "base_dark.html" %} {% block title %}Dashboard - BotManager{%
endblock %} {% block content %}
<!-- Dashboard Header -->
<header class="dashboard-header">
  <div class="header-left">
    <h1>
      Bem-vindo de volta, {{ session.user_name or current_user.username or
      'Usuário' }}
    </h1>
    <p>Monitore seus bots e métricas do Telegram</p>
  </div>
</header>

<!-- Filters Section -->
<div class="filters-section">
  <div class="filters-grid">
    <div class="filter-group">
      <label class="filter-label">Período</label>
      <input
        type="date"
        id="startDate"
        class="filter-input"
        value="{{ start_date }}"
      />
    </div>
    <div class="filter-group">
      <label class="filter-label">Até</label>
      <input
        type="date"
        id="endDate"
        class="filter-input"
        value="{{ end_date }}"
      />
    </div>
    <div class="filter-group">
      <label class="filter-label">Bot</label>
      <select id="botFilter" class="filter-select">
        <option value="">Todos os bots</option>
        {% for bot in bots %}
        <option value="{{ bot.id }}" {% if bot.id|string == selected_bot_id %}selected{% endif %}>
          {{ bot.bot_username or  bot.bot_name  or 'Bot #' + bot.id|string }}
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-group">
      <button onclick="applyFilters()" class="btn-primary">
        <i class="fas fa-filter"></i>
        Aplicar filtros
      </button>
    </div>
  </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-title">
        <i class="fas fa-play"></i>
        Iniciações do bot (/start)
      </span>
    </div>
    <div class="stat-value">{{ stats.bot_starts|default(0) }}</div>
    <div class="stat-change positive">
      +{{ stats.bot_starts_change|default(0) }}%
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-title">
        <i class="fas fa-crown"></i>
        Assinaturas
      </span>
    </div>
    <div class="stat-value">{{ stats.subscriptions|default(0) }}</div>
    <div class="stat-change positive">
      +{{ stats.subscriptions_change|default(0) }}%
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-title">
        <i class="fas fa-chart-line"></i>
        Sessões ativas
      </span>
    </div>
    <div class="stat-value">{{ stats.active_sessions|default(0) }}</div>
    <div class="stat-change positive">
      +{{ stats.sessions_change|default(0) }}%
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-title">
        <i class="fas fa-calendar-day"></i>
        Hoje
      </span>
    </div>
    <div class="stat-value">R$ {{ stats.today_revenue|default('0.00') }}</div>
    <div class="stat-change neutral">
      {{ stats.today_payments_count|default(0) }} pagamento{{ 's' if stats.today_payments_count != 1 else '' }}
    </div>
  </div>
</div>

<!-- Charts Section -->
<div class="charts-grid">
  <!-- Revenue Chart -->
  <div class="chart-card large">
    <div class="chart-header">
      <h3>Faturamento total</h3>
      <div class="chart-value">
        R$ {{ stats.total_revenue|default('0.00') }}
        <span class="change positive"
          >+{{ stats.revenue_change|default(0) }}%</span
        >
      </div>
      <div class="chart-legend">
        <span class="legend-item">
          <span class="legend-dot purple"></span>
          Faturamento Total
        </span>
        <span class="chart-period"
          >{{ period_label|default('Últimos 30 dias') }}</span
        >
      </div>
    </div>
    <div class="chart-container">
      <canvas id="revenueChart"></canvas>
    </div>
  </div>

  <!-- Sessions Chart -->
  <div class="chart-card small">
    <div class="chart-header">
      <h4>Porcentagem de sessões</h4>
      <div class="chart-value">
        {{ stats.session_percentage|default(0) }}%
        <span class="change positive"
          >+{{ stats.sessions_change|default(0) }}%</span
        >
      </div>
    </div>
    <div class="chart-container">
      <canvas id="sessionsChart"></canvas>
    </div>
  </div>


  
<!-- Services Status -->
<div class="stat-card">
  <div class="services-header">
    <h3><i class="fas fa-heartbeat"></i> Status dos Serviços</h3>
    <button onclick="checkServices()" class="test-services-btn btn-sm btn-outline-primary" id="checkServicesBtn">
      <i class="fas fa-sync-alt"></i> Verificar Agora
    </button>
  </div>
  <div class="status-grid">
    {% for service in services_status %}
    <div class="status-card {{ 'online' if service.status == 'online' else 'offline' }}">
      <div class="status-header">
        <span class="status-name">{{ service.name }}</span>
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span class="status-text">{{ 'Online' if service.status == 'online' else 'Offline' }}</span>
        </div>
      </div>
      <div class="status-details">
        <div class="response-time">
          {% if service.response_time and service.response_time > 0 %}
          <i class="fas fa-clock"></i>
          {{ "%.0f"|format(service.response_time) }}ms
          {% else %}
          <i class="fas fa-times-circle"></i>
          Sem resposta
          {% endif %}
        </div>
        <div class="last-check">
          <i class="fas fa-calendar-alt"></i>
          Verificado: {{ service.last_check.strftime('%H:%M:%S') if service.last_check else 'N/A' }}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

</div>
{% endblock %}

{% block scripts %}
<script>
  // Dados do gráfico direto do servidor
  const chartData = {{ chart_data|tojson|safe if chart_data else '{}' }};
  // Função para aplicar filtros
  function applyFilters() {
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    const botId = document.getElementById("botFilter").value;

    const params = new URLSearchParams();
    if (startDate) params.append("start_date", startDate);
    if (endDate) params.append("end_date", endDate);
    if (botId) params.append("bot_id", botId);

    window.location.href = `{{ url_for('main.dashboard') }}?${params.toString()}`;
  }

  // Debug: Log chart data
  console.log("=== DEBUG FRONTEND ===");
  console.log("Chart Data:", chartData);
  console.log("Chart Data type:", typeof chartData);
  console.log("Revenue Labels:", chartData.revenue_labels);
  console.log("Revenue Data:", chartData.revenue_data);
  console.log("Revenue Labels length:", chartData.revenue_labels?.length);
  console.log("Revenue Data length:", chartData.revenue_data?.length);

  // Verificar se Chart.js está disponível
  if (typeof Chart !== "undefined") {
    console.log("Chart.js is available");
    
    // Revenue Chart
    const revenueCanvas = document.getElementById("revenueChart");
    if (revenueCanvas) {
      console.log("Revenue canvas found");
      const revenueCtx = revenueCanvas.getContext("2d");
      const revenueLabels = chartData.revenue_labels || [];
      const revenueData = chartData.revenue_data || [];
      const feesData = chartData.fees_data || [];

      console.log("Creating chart with labels:", revenueLabels);
      console.log("Creating chart with data:", revenueData);

      try {
        const revenueChart = new Chart(revenueCtx, {
          type: "line",
          data: {
            labels: revenueLabels,
            datasets: [
              {
                label: "Faturamento Líquido",
                data: revenueData,
                borderColor: "#8b5cf6",
                backgroundColor: "rgba(139, 92, 246, 0.1)",
                fill: false,
                tension: 0.4,
                borderWidth: 2,
                pointBackgroundColor: "#8b5cf6",
                pointBorderColor: "#ffffff",
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  color: '#9ca3af',
                  font: {
                    size: 12
                  }
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: '#8b5cf6',
                borderWidth: 1,
                callbacks: {
                  label: function(context) {
                    return 'Faturamento: R$ ' + context.parsed.y.toLocaleString('pt-BR', {
                      minimumFractionDigits: 2,
                      maximumFractionDigits: 2
                    });
                  }
                }
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: "rgba(255, 255, 255, 0.1)",
                  drawBorder: false,
                },
                ticks: {
                  color: "#9ca3af",
                  padding: 10,
                  callback: function (value) {
                    return "R$ " + value.toLocaleString("pt-BR", {
                      minimumFractionDigits: 0,
                      maximumFractionDigits: 0
                    });
                  },
                },
              },
              x: {
                grid: {
                  color: "rgba(255, 255, 255, 0.05)",
                  drawBorder: false,
                },
                ticks: {
                  color: "#9ca3af",
                  padding: 10,
                },
              },
            },
          },
        });
        console.log("Chart created successfully:", revenueChart);
      } catch (error) {
        console.error("Error creating chart:", error);
      }
    } else {
      console.log("Revenue canvas not found");
    }

    // Sessions Chart
    const sessionsCanvas = document.getElementById("sessionsChart");
    if (sessionsCanvas) {
      const sessionsCtx = sessionsCanvas.getContext("2d");
      const sessionsLabels = chartData.sessions_labels || [];
      const sessionsData = chartData.sessions_data || [];

      new Chart(sessionsCtx, {
        type: "line",
        data: {
          labels: sessionsLabels,
          datasets: [
            {
              data: sessionsData,
              borderColor: "#8b5cf6",
              backgroundColor: "rgba(139, 92, 246, 0.1)",
              fill: true,
              tension: 0.4,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            },
          },
          scales: {
            y: {
              display: false,
            },
            x: {
              grid: {
                display: false,
              },
              ticks: {
                color: "#9ca3af",
                font: {
                  size: 10,
                },
              },
            },
          },
        },
      });
    }
  }

  // Função para verificar serviços manualmente
  async function checkServices() {
    const btn = document.getElementById('checkServicesBtn');
    const originalText = btn.innerHTML;
    
    // Desabilita botão e mostra loading
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
    
    try {
      const response = await fetch('/api/services/check');
      const data = await response.json();
      
      if (response.ok) {
        // Recarrega a página para mostrar os novos status
        window.location.reload();
      } else {
        console.error('Erro ao verificar serviços:', data);
      }
    } catch (error) {
      console.error('Erro na requisição:', error);
    } finally {
      // Restaura botão
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  }

  // Mobile sidebar toggle
  function toggleSidebar() {
    const sidebar = document.querySelector(".sidebar");
    if (sidebar) {
      sidebar.classList.toggle("active");
    }
  }

  // Auto-refresh data every 5 minutes
  setInterval(() => {
    if (!window.location.search) {
      window.location.reload();
    }
  }, 300000);
</script>

<!-- Mobile menu button -->
<button class="mobile-menu-btn d-md-none" onclick="toggleSidebar()">
  <i class="fas fa-bars"></i>
</button>
{% endblock %}
