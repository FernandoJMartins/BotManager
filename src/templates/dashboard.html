{% extends "base_dark.html" %} {% block title %}Dashboard - BotManager{%
endblock %} {% block content %}
<!-- Dashboard Header -->
<header class="dashboard-header">
  <div class="header-left">
    <h1>
      Bem-vindo de volta, {{ session.user_name or current_user.username or
      'Usuário' }}
    </h1>
    <p>Monitore seus bots e métricas do Telegram</p>
  </div>
</header>

<!-- Filters Section -->
<div class="filters-section">
  <div class="filters-grid">
    <div class="filter-group">
      <label class="filter-label">Período</label>
      <input
        type="date"
        id="startDate"
        class="filter-input"
        value="{{ start_date }}"
      />
    </div>
    <div class="filter-group">
      <label class="filter-label">Até</label>
      <input
        type="date"
        id="endDate"
        class="filter-input"
        value="{{ end_date }}"
      />
    </div>
    <div class="filter-group">
      <label class="filter-label">Bot</label>
      <select id="botFilter" class="filter-select">
        <option value="">Todos os bots</option>
        {% for bot in bots %}
        <option value="{{ bot.id }}" {% if bot.id|string == selected_bot_id %}selected{% endif %}>
          {{ bot.bot_name or bot.bot_username or 'Bot #' + bot.id|string }}
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-group">
      <button onclick="applyFilters()" class="btn-primary">
        <i class="fas fa-filter"></i>
        Aplicar filtros
      </button>
    </div>
  </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-title">
        <i class="fas fa-play"></i>
        Iniciações do bot (/start)
      </span>
    </div>
    <div class="stat-value">{{ stats.bot_starts|default(0) }}</div>
    <div class="stat-change positive">
      +{{ stats.bot_starts_change|default(0) }}%
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-title">
        <i class="fas fa-crown"></i>
        Assinaturas
      </span>
    </div>
    <div class="stat-value">{{ stats.subscriptions|default(0) }}</div>
    <div class="stat-change positive">
      +{{ stats.subscriptions_change|default(0) }}%
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-title">
        <i class="fas fa-chart-line"></i>
        Sessões ativas
      </span>
    </div>
    <div class="stat-value">{{ stats.active_sessions|default(0) }}</div>
    <div class="stat-change positive">
      +{{ stats.sessions_change|default(0) }}%
    </div>
  </div>
</div>

<!-- Charts Section -->
<div class="charts-grid">
  <!-- Revenue Chart -->
  <div class="chart-card large">
    <div class="chart-header">
      <h3>Faturamento total</h3>
      <div class="chart-value">
        R$ {{ stats.total_revenue|default('0.00') }}
        <span class="change positive"
          >+{{ stats.revenue_change|default(0) }}%</span
        >
      </div>
      <div class="chart-legend">
        <span class="legend-item">
          <span class="legend-dot purple"></span>
          Faturamento Líquido
        </span>
        <span class="chart-period"
          >{{ period_label|default('Últimos 30 dias') }}</span
        >
      </div>
    </div>
    <div class="chart-container">
      <canvas id="revenueChart"></canvas>
    </div>
  </div>

  <!-- Sessions Chart -->
  <div class="chart-card small">
    <div class="chart-header">
      <h4>Porcentagem de sessões</h4>
      <div class="chart-value">
        {{ stats.session_percentage|default(0) }}%
        <span class="change positive"
          >+{{ stats.sessions_change|default(0) }}%</span
        >
      </div>
    </div>
    <div class="chart-container">
      <canvas id="sessionsChart"></canvas>
    </div>
  </div>
</div>
{% endblock %}

<!-- Data for Charts -->
<script type="application/json" id="chartData">
  {
      "revenue_labels": {% if chart_data %}{{ chart_data.revenue_labels|tojson|safe }}{% else %}[]{% endif %},
      "revenue_data": {% if chart_data %}{{ chart_data.revenue_data|tojson|safe }}{% else %}[]{% endif %},
      "fees_data": {% if chart_data %}{{ chart_data.fees_data|tojson|safe }}{% else %}[]{% endif %},
      "sessions_labels": {% if chart_data %}{{ chart_data.sessions_labels|tojson|safe }}{% else %}[]{% endif %},
      "sessions_data": {% if chart_data %}{{ chart_data.sessions_data|tojson|safe }}{% else %}[]{% endif %}
  }
</script>

{% block scripts %}
<script>
  // Função para aplicar filtros
  function applyFilters() {
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    const botId = document.getElementById("botFilter").value;

    const params = new URLSearchParams();
    if (startDate) params.append("start_date", startDate);
    if (endDate) params.append("end_date", endDate);
    if (botId) params.append("bot_id", botId);

    window.location.href = `{{ url_for('dashboard') }}?${params.toString()}`;
  }

  // Carregar dados do chart
  const chartDataElement = document.getElementById("chartData");
  const chartData = chartDataElement
    ? JSON.parse(chartDataElement.textContent)
    : {};

  // Verificar se Chart.js está disponível
  if (typeof Chart !== "undefined") {
    // Revenue Chart
    const revenueCanvas = document.getElementById("revenueChart");
    if (revenueCanvas) {
      const revenueCtx = revenueCanvas.getContext("2d");
      const revenueLabels = chartData.revenue_labels || [];
      const revenueData = chartData.revenue_data || [];
      const feesData = chartData.fees_data || [];

      new Chart(revenueCtx, {
        type: "line",
        data: {
          labels: revenueLabels,
          datasets: [
            {
              label: "Faturamento Líquido",
              data: revenueData,
              borderColor: "#8b5cf6",
              backgroundColor: "rgba(139, 92, 246, 0.15)",
              fill: "origin",
              tension: 0.4,
              borderWidth: 3,
              pointBackgroundColor: "#8b5cf6",
              pointBorderColor: "#ffffff",
              pointBorderWidth: 2,
              pointRadius: 5,
              pointHoverRadius: 7,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              display: false,
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#8b5cf6',
              borderWidth: 1,
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: "rgba(255, 255, 255, 0.1)",
                drawBorder: false,
              },
              ticks: {
                color: "#9ca3af",
                padding: 10,
                callback: function (value) {
                  return "R$ " + value.toLocaleString("pt-BR", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                  });
                },
              },
            },
            x: {
              grid: {
                color: "rgba(255, 255, 255, 0.05)",
                drawBorder: false,
              },
              ticks: {
                color: "#9ca3af",
                padding: 10,
              },
            },
          },
        },
      });
    }

    // Sessions Chart
    const sessionsCanvas = document.getElementById("sessionsChart");
    if (sessionsCanvas) {
      const sessionsCtx = sessionsCanvas.getContext("2d");
      const sessionsLabels = chartData.sessions_labels || [];
      const sessionsData = chartData.sessions_data || [];

      new Chart(sessionsCtx, {
        type: "line",
        data: {
          labels: sessionsLabels,
          datasets: [
            {
              data: sessionsData,
              borderColor: "#8b5cf6",
              backgroundColor: "rgba(139, 92, 246, 0.1)",
              fill: true,
              tension: 0.4,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            },
          },
          scales: {
            y: {
              display: false,
            },
            x: {
              grid: {
                display: false,
              },
              ticks: {
                color: "#9ca3af",
                font: {
                  size: 10,
                },
              },
            },
          },
        },
      });
    }
  }

  // Mobile sidebar toggle
  function toggleSidebar() {
    const sidebar = document.querySelector(".sidebar");
    if (sidebar) {
      sidebar.classList.toggle("active");
    }
  }

  // Auto-refresh data every 5 minutes
  setInterval(() => {
    if (!window.location.search) {
      window.location.reload();
    }
  }, 300000);
</script>

<!-- Mobile menu button -->
<button class="mobile-menu-btn d-md-none" onclick="toggleSidebar()">
  <i class="fas fa-bars"></i>
</button>
{% endblock %}
